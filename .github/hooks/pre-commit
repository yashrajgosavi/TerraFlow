# Store this file in .git/hooks/
#!/bin/bash

# Get a list of staged Terraform files
terraform_files=$(git diff --cached --name-only --diff-filter=AM | grep '\.tf$')

if [[ -z "$terraform_files" ]]; then
    exit 0
fi

# Run terraform fmt and check for changes
formatted_files=()
for file in $terraform_files; do
    terraform fmt -diff -write=false "$file"
    if ! git diff --exit-code "$file" > /dev/null; then
        formatted_files+=("$file")
    fi
done

if [[ ${#formatted_files[@]} -ne 0 ]]; then
    echo "The following Terraform files are not formatted correctly:"
    for file in "${formatted_files[@]}"; do
        echo " - $file"
    done
    echo "Run 'terraform fmt' to fix formatting."
    exit 1
fi

exit 0
